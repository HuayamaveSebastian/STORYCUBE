# ==================== MAKEFILE STORYCUBE ====================
# Proyecto: StoryCube - CuÃ©ntacuentos Interactivo
# Placa: MH-ET LIVE MiniKit ESP32
# PropÃ³sito: Compilar y cargar cÃ³digo en ESP32
# ============================================================

# ==================== CONFIGURACIÃ“N ====================

# Puerto serial (ajusta segÃºn tu sistema)
# Linux:   /dev/ttyUSB0, /dev/ttyUSB1
# macOS:   /dev/cu.usbserial-XXXXX
# Windows: COM3, COM4, etc.
PORT ?= /dev/ttyUSB0

# Velocidad de baudrate para monitoreo
BAUD_RATE = 115200

# Entorno de PlatformIO
ENV = mhetesp32devkit

# ==================== COMANDOS PRINCIPALES ====================

.PHONY: all build upload monitor clean help upload-monitor check-port check-pio

# Verificar si PlatformIO estÃ¡ instalado
check-pio:
	@command -v pio >/dev/null 2>&1 || { \
		echo "âŒ PlatformIO no estÃ¡ instalado."; \
		echo "ğŸ“¦ InstÃ¡lalo desde VS Code o ejecuta:"; \
		echo "   pip install platformio"; \
		exit 1; \
	}

# Comando por defecto: compilar y cargar
all: check-pio build upload
	@echo "âœ“ Â¡CompilaciÃ³n y carga completadas!"

# Compilar el proyecto
build: check-pio
	@echo "ğŸ”¨ Compilando StoryCube para $(ENV)..."
	@pio run -e $(ENV)
	@echo "âœ“ CompilaciÃ³n exitosa"

# Cargar en el ESP32
upload: check-pio build
	@echo "ğŸ“¤ Cargando firmware en ESP32 (puerto: $(PORT))..."
	@pio run -e $(ENV) --target upload --upload-port $(PORT)
	@echo "âœ“ Firmware cargado correctamente"

# Monitorear puerto serial
monitor: check-pio
	@echo "ğŸ“¡ Monitoreando puerto serial ($(PORT)) a $(BAUD_RATE) baud..."
	@echo "   Presiona Ctrl+C para salir"
	@pio device monitor -p $(PORT) -b $(BAUD_RATE) -e $(ENV)

# Cargar y monitorear en una sola acciÃ³n
upload-monitor:
	@make upload
	@echo ""
	@echo "Abriendo monitor serial..."
	@sleep 2
	@make monitor

# Compilar sin cargar
build-only: check-pio
	@echo "ğŸ”¨ Compilando solo (sin cargar)..."
	@pio run -e $(ENV)

# Limpiar archivos compilados
clean: check-pio
	@echo "ğŸ§¹ Limpiando archivos compilados..."
	@pio run -e $(ENV) --target clean
	@echo "âœ“ Limpieza completada"

# Verificar puerto serial disponible
check-port: check-pio
	@echo "ğŸ” Puertos seriales disponibles:"
	@pio device list
	@echo ""
	@echo "Si tu puerto es diferente, usa:"
	@echo "  make upload PORT=/dev/ttyUSB1"
	@echo "  make upload PORT=COM4"

# Mostrar ayuda
help:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘     STORYCUBE - Makefile para ESP32 MH-ET DevKit       â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“‹ COMANDOS DISPONIBLES:"
	@echo ""
	@echo "  make              â†’ Compilar y cargar (predeterminado)"
	@echo "  make all          â†’ Compilar y cargar"
	@echo "  make build        â†’ Solo compilar"
	@echo "  make build-only   â†’ Compilar sin cargar"
	@echo "  make upload       â†’ Compilar y cargar"
	@echo "  make monitor      â†’ Abrir monitor serial"
	@echo "  make upload-monitor â†’ Cargar y monitorear"
	@echo "  make clean        â†’ Limpiar archivos compilados"
	@echo "  make check-port   â†’ Ver puertos seriales disponibles"
	@echo "  make help         â†’ Mostrar esta ayuda"
	@echo ""
	@echo "âš™ï¸  CONFIGURACIÃ“N ACTUAL:"
	@echo ""
	@echo "  Puerto:     $(PORT)"
	@echo "  Baudrate:   $(BAUD_RATE)"
	@echo "  Entorno:    $(ENV)"
	@echo "  Placa:      MH-ET LIVE MiniKit ESP32"
	@echo ""
	@echo "ğŸ“ EJEMPLOS DE USO:"
	@echo ""
	@echo "  # Compilar y cargar automÃ¡ticamente"
	@echo "  $$ make"
	@echo ""
	@echo "  # Cargar en puerto especÃ­fico"
	@echo "  $$ make upload PORT=/dev/ttyUSB1"
	@echo ""
	@echo "  # Monitorear salida"
	@echo "  $$ make monitor"
	@echo ""
	@echo "  # Cargar y ver output en tiempo real"
	@echo "  $$ make upload-monitor"
	@echo ""
	@echo "  # Limpiar y recompilar desde cero"
	@echo "  $$ make clean && make build"
	@echo ""
	@echo "ğŸ”§ SOLUCIONAR PROBLEMAS:"
	@echo ""
	@echo "  Puerto no reconocido:"
	@echo "    $$ make check-port"
	@echo ""
	@echo "  LibrerÃ­as no encontradas:"
	@echo "    $$ pio run -e $(ENV)  (descarga automÃ¡ticamente)"
	@echo ""

# ==================== COMANDOS ADICIONALES ====================

# Actualizar librerÃ­as
update-libs: check-pio
	@echo "ğŸ“š Actualizando librerÃ­as..."
	@pio lib update
	@echo "âœ“ LibrerÃ­as actualizadas"

# Ver informaciÃ³n del proyecto
info: check-pio
	@echo "ğŸ“Š InformaciÃ³n del proyecto:"
	@pio project config

# Reinstalar librerÃ­as
reinstall-libs: check-pio
	@echo "ğŸ”„ Reinstalando librerÃ­as..."
	@pio run -e $(ENV) --target clean
	@pio lib install --force
	@echo "âœ“ LibrerÃ­as reinstaladas"

.PHONY: update-libs info reinstall-libs
